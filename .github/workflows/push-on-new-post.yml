name: Push notification on new blog post

on:
  push:
    branches: ["main"]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find changed post file
        id: changed
        shell: bash
        run: |
          set -e
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          POST_FILE=$(echo "$CHANGED_FILES" | grep -E '^src/content/posts/.*\.(md|mdx)$' | head -n 1 || true)
          echo "post_file=$POST_FILE" >> $GITHUB_OUTPUT

      - name: Exit if no post changed
        if: steps.changed.outputs.post_file == ''
        run: echo "No post file changed. Exiting."

      - name: Extract title + slug
        if: steps.changed.outputs.post_file != ''
        id: meta
        shell: bash
        run: |
          set -e
          FILE="${{ steps.changed.outputs.post_file }}"

          TITLE=$(awk '
            BEGIN{FS=":"}
            /^title[[:space:]]*:/{
              sub(/^title[[:space:]]*:[[:space:]]*/, "", $0);
              gsub(/^["'\'']|["'\'']$/, "", $0);
              print $0;
              exit
            }' "$FILE")
          if [ -z "$TITLE" ]; then TITLE="New post"; fi

          SLUG=$(awk '
            BEGIN{FS=":"}
            /^slug[[:space:]]*:/{
              sub(/^slug[[:space:]]*:[[:space:]]*/, "", $0);
              gsub(/^["'\'']|["'\'']$/, "", $0);
              print $0;
              exit
            }' "$FILE")
          if [ -z "$SLUG" ]; then
            BASE=$(basename "$FILE")
            SLUG="${BASE%.*}"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "slug=$SLUG" >> $GITHUB_OUTPUT

      - name: Call push webhook
        if: steps.changed.outputs.post_file != ''
        shell: bash
        run: |
          set -e
          TITLE="${{ steps.meta.outputs.title }}"
          SLUG="${{ steps.meta.outputs.slug }}"
          URL="/posts/${SLUG}"

          curl -sS -X POST "${{ secrets.PUSH_WEBHOOK_URL }}" \
            -H "content-type: application/json" \
            -H "authorization: Bearer ${{ secrets.PUSH_WEBHOOK_SECRET }}" \
            -d "{\"title\":\"${TITLE}\",\"message\":\"A new post is live.\",\"url\":\"${URL}\"}"
