name: Push notifications

on:
  push:
    branches: [main]
    paths:
      - "src/content/posts/**"
      - "src/pages/updates.astro"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show commit + changed files
        run: |
          echo "before: ${{ github.event.before }}"
          echo "sha:    ${{ github.sha }}"
          echo "Changed files:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }}

      - name: Send push for updates page (if changed)
        env:
          PUSH_WEBHOOK_URL: ${{ secrets.PUSH_WEBHOOK_URL }}
          PUSH_WEBHOOK_SECRET: ${{ secrets.PUSH_WEBHOOK_SECRET }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          set -e

          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^src/pages/updates\.astro$" || exit 0

          TITLE=$(awk '
            /PUSH_META/{f=1;next}
            /PUSH_META_END/{f=0}
            f && $0 ~ /title:/ { sub(/^.*title:[[:space:]]*/, "", $0); print; exit }
          ' src/pages/updates.astro)

          MESSAGE=$(awk '
            /PUSH_META/{f=1;next}
            /PUSH_META_END/{f=0}
            f && $0 ~ /message:/ { sub(/^.*message:[[:space:]]*/, "", $0); print; exit }
          ' src/pages/updates.astro)

          [ -z "$TITLE" ] && TITLE="New update"
          [ -z "$MESSAGE" ] && MESSAGE="A new update is live. Tap to read."

          esc() { printf '%s' "$1" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read())[1:-1])'; }
          TITLE_ESC=$(esc "$TITLE")
          MESSAGE_ESC=$(esc "$MESSAGE")

          curl -i -sS -X POST "$PUSH_WEBHOOK_URL" \
            -H "content-type: application/json" \
            -H "authorization: Bearer $PUSH_WEBHOOK_SECRET" \
            --data "{\"title\":\"$TITLE_ESC\",\"message\":\"$MESSAGE_ESC\",\"url\":\"/updates\"}"

      - name: Use Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm ci

      - name: Send push notifications for posts (if changed)
        env:
          PUSH_WEBHOOK_URL: ${{ secrets.PUSH_WEBHOOK_URL }}
          PUSH_WEBHOOK_SECRET: ${{ secrets.PUSH_WEBHOOK_SECRET }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          export CHANGED_FILES="$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})"
          node scripts/push-from-changes.mjs