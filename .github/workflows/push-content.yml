name: Push notifications

on:
  push:
    branches: [main]
    paths:
      - "src/content/posts/**"
      - "src/pages/updates.astro"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files (robust)
        id: changes
        run: |
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "Changed files:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }}

      # -------- SEND PUSH FOR UPDATES.ASTRO (direct, no Node script) --------
      - name: Send push for updates page (if changed)
        env:
          PUSH_WEBHOOK_URL: ${{ secrets.PUSH_WEBHOOK_URL }}
          PUSH_WEBHOOK_SECRET: ${{ secrets.PUSH_WEBHOOK_SECRET }}
        run: |
          echo "$CHANGED_FILES" | grep -q "^src/pages/updates\.astro$" || exit 0

          # Extract title + message from PUSH_META block
          TITLE=$(awk '
            /PUSH_META/{f=1;next}
            /PUSH_META_END/{f=0}
            f && $0 ~ /title:/ { sub(/^.*title:[[:space:]]*/, "", $0); print; exit }
          ' src/pages/updates.astro)

          MESSAGE=$(awk '
            /PUSH_META/{f=1;next}
            /PUSH_META_END/{f=0}
            f && $0 ~ /message:/ { sub(/^.*message:[[:space:]]*/, "", $0); print; exit }
          ' src/pages/updates.astro)

          # Fallbacks if not found
          [ -z "$TITLE" ] && TITLE="New update"
          [ -z "$MESSAGE" ] && MESSAGE="A new update is live. Tap to read."

          echo "Sending updates push:"
          echo "TITLE=$TITLE"
          echo "MESSAGE=$MESSAGE"

          curl -sS -X POST "$PUSH_WEBHOOK_URL" \
            -H "content-type: application/json" \
            -H "authorization: Bearer $PUSH_WEBHOOK_SECRET" \
            --data "{\"title\":\"$TITLE\",\"message\":\"$MESSAGE\",\"url\":\"/updates\"}"

      # -------- SEND PUSH FOR POSTS (Node script) --------
      - name: Use Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm ci

      - name: Send push notifications for posts (if changed)
        env:
          PUSH_WEBHOOK_URL: ${{ secrets.PUSH_WEBHOOK_URL }}
          PUSH_WEBHOOK_SECRET: ${{ secrets.PUSH_WEBHOOK_SECRET }}
          CHANGED_FILES: ${{ env.CHANGED_FILES }}
        run: node scripts/push-from-changes.mjs