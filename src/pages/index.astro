---
// @ts-nocheck
// Homepage
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Get all posts, sorted by date (newest first)
const allPosts = await getCollection("posts");
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get the latest 2 posts for the homepage
const latestPosts = sortedPosts.slice(0, 2);
---

<BaseLayout
  title="Lystaria · Where the Mystical Meets the Mundane"
  description="A space for exploring magic, personal growth, mental wellness, and the philosophies that shape us. By Asteria."
  image="/banner.png"
  type="website"
>
  <div class="container">
    <section class="hero">
      <h1>Welcome to Lystaria</h1>
      <p class="intro">
        Where the mystical meets the mundane. A space for exploring the magic
        woven into everyday life--through personal growth, mental wellness, and
        the philosophies that shape us. Here, we honor both the cosmic and the
        practical, the spiritual and the human.
      </p>

      <div class="moon-phase" id="moon-phase">
        <span class="moon-text">Calculating moon phase...</span>
      </div>
    </section>

    <section class="featured-posts">
      <h2>Latest Spells & Stories</h2>

      <div class="post-grid">
        {
          latestPosts.map((post) => {
            const formattedDate = new Date(
              post.data.pubDate
            ).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            return (
              <article class="post-card">
                {post.data.coverImage && (
                  <div class="post-media">
                    <img
                      src={post.data.coverImage}
                      alt=""
                      loading="lazy"
                      class="post-cover"
                    />
                  </div>
                )}

                {/* Big clickable area (title/desc/read-more) */}
                <a class="post-link" href={`/blog/${post.slug}`}>
                  <div class="post-content">
                    <h3>{post.data.title}</h3>
                    <p class="post-date">{formattedDate}</p>
                    <p class="post-description">{post.data.description}</p>
                    <div class="read-more">Read more →</div>
                  </div>
                </a>

                {/* Tags stay outside the big link so they remain clickable */}
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="post-tags">
                    {post.data.tags.slice(0, 3).map((tag) => (
                      <a href={`/blog/tag/${tag}`} class="tag">
                        {tag}
                      </a>
                    ))}
                  </div>
                )}
              </article>
            );
          })
        }
      </div>

      <div class="view-all">
        <a href="/blog" class="view-all-link">View All Posts →</a>
      </div>
    </section>
  </div>

  <style>
 .container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem;
}

/* HERO */
.hero {
  text-align: center;
  padding: 3rem 0 4rem;

  /* FIX: gap only works with flex/grid */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1.5rem;

  /* border-bottom: 1px solid var(--color-border); */
}

.hero h1 {
  font-size: 2rem;
  margin: 0;
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* INTRO BOX */
.intro {
  max-width: 700px;
  width: 100%;
  margin: 0 auto; /* FIX: stable centering */
  padding: 2rem;

  border: 2px dotted transparent;
  border-image: var(--gradient-accent) 1;

  /* Note: border-radius won't clip border-image, known limitation */
  border-radius: 8px;

  font-size: 0.85rem;
  color: #ffffff;
}

/* =========================================================
   MOON PHASE
   FIX: remove duplicated container styling.
   Use #moon-phase as the ONE true container.
   ========================================================= */

/* REMOVE the duplicate container block by neutralizing it:
   .moon-phase should behave like text inside the card, not a box. */
.moon-phase {
  display: inline;
  padding: 0;
  margin: 0;
  background: none;
  border: 0;
  border-radius: 0;
  font-size: inherit;
}

/* Outer container */
#moon-phase {
  display: inline-block;
  padding: 0.9rem 1.25rem;
  background-color: var(--color-bg-secondary);
  border: 1px solid var(--color-border);
  border-radius: 12px;

  /* FIX: let .hero gap control spacing */
  margin-top: 0;
}

/* Inner wrapper */
.moon-info-main {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

/* Moon icon */
.moon-icon {
  width: 1.6em;
  height: 1.6em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  line-height: 1;
}

.moon-icon img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain;
}

.moon-text-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

/* This stays, and now it ONLY affects the text element */
.moon-text-group .moon-phase {
  font-size: 1.6rem;
  color: var(--color-accent-bright);
  letter-spacing: 0.05em;
  font-weight: 600;
  line-height: 1.2;
}

.moon-divider {
  color: var(--color-text-muted);
  margin: 0 0.25rem;
}

.moon-details {
  font-size: 1rem;
  color: var(--color-text-muted);
}

/* FEATURED POSTS SECTION */
.featured-posts {
  text-align: center;
  max-width: 1200px;

  /* FIX: match container centering */
  margin: 0 auto;

  /* FIX: slightly tighter rhythm so it doesn’t feel like a giant drop */
  padding: 3rem 0;
}

.featured-posts h2 {
  font-size: 2rem;

  /* FIX: make heading spacing predictable */
  margin: 0 0 2rem;
}

.post-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
  text-align: left;
}

/* =========================
   HOMEPAGE POST CARDS
   ========================= */

.post-card {
  text-align: left;
  background: linear-gradient(
    150deg,
    #9a2dfe 10%,
    #9a2dfe 32%,
    #f6f65a 38%,
    #e019d4 60%,
    #00dbff 72%,
    #00dbff 100%
  );
  border: 1px solid var(--color-border);
  border-radius: 12px;
  padding: 0;
  transition: transform 0.2s ease, border-color 0.2s ease;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  position: relative;
}

.post-card::after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 240px;
  bottom: 0;
  background: rgba(10, 10, 15, 0.45);
  pointer-events: none;
  z-index: 0;
}

.post-card > * {
  position: relative;
  z-index: 1;
}

.post-card:hover {
  transform: translateY(-4px);
  border-color: var(--color-accent);
}

.post-media {
  position: relative;
  width: 100%;
  height: 240px;
  overflow: hidden;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.post-media::after {
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: linear-gradient(
    135deg,
    rgba(126, 126, 255, 0.14),
    rgba(90, 200, 250, 0.1),
    rgba(10, 10, 15, 0.22)
  );
}

.post-cover {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0.95;
  transition: transform 0.35s ease, opacity 0.35s ease;
}

.post-card:hover .post-cover {
  transform: scale(1.03);
  opacity: 1;
}

.post-link {
  display: block;
  color: inherit;
  text-decoration: none;
}

.post-content {
  padding: 1.75rem 1.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.post-content h3 {
  font-size: 1.8rem;
  margin: 0;
  background: none !important;
  -webkit-background-clip: initial !important;
  background-clip: initial !important;
  -webkit-text-fill-color: #ffffff !important;
  color: #ffffff !important;
  line-height: 1.2;
}

.post-date {
  margin: 0;
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.9rem;
  font-style: italic;
}

.post-description {
  margin: 0;
  color: rgba(255, 255, 255, 0.85);
  line-height: 1.6;
}

.read-more {
  display: inline-block;
  align-self: flex-start;
  margin-top: auto;
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
  font-weight: 500;
  letter-spacing: 0.02em;
  color: #ffffff;
  background: rgba(10, 10, 15, 0.75);
  border: 1px solid var(--color-border);
  border-radius: 999px;
  transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
}

.post-card:hover .read-more {
  border-color: var(--color-accent);
  background: rgba(10, 10, 15, 0.9);
  transform: translateY(-1px);
}

.post-tags {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding: 0 1.75rem 1.5rem;
}

.tag {
  background-color: var(--color-bg);
  color: var(--color-accent);
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.85rem;
  border: 1px solid var(--color-border);
  text-decoration: none;
  transition: transform 0.2s ease, background 0.2s ease, color 0.2s ease;
  position: relative;
  z-index: 2;
}

.tag:hover {
  background-color: var(--color-accent);
  color: var(--color-bg);
  transform: translateY(-2px);
}

.view-all {
  text-align: center;
}

.view-all-link {
  display: inline-block;
  padding: 0.75rem 2rem;
  background-color: var(--color-bg-secondary);
  border: 1px solid var(--color-accent);
  border-radius: 50px;
  color: var(--color-accent-bright);
  font-size: 1rem;
  transition: all 0.3s ease;
  text-decoration: none;
}

.view-all-link:hover {
  background-color: var(--color-accent);
  color: var(--color-bg);
  transform: translateY(-2px);
}

/* MOBILE CONFIGS */
@media (max-width: 768px) {
  .container {
    padding: 0 1.25rem;
  }

  .hero {
    padding: 2.5rem 0 3rem;
    gap: 1.25rem;
  }

  .hero h1 {
    font-size: 2rem;
  }

  .intro {
    font-size: 0.9rem;
    padding: 1.5rem;
  }

  .post-grid {
    grid-template-columns: 1fr;
  }

  .post-media {
    height: 200px;
  }

  .post-card::after {
    top: 200px;
  }

  .post-content {
    padding: 1.25rem 1.25rem;
  }

  .post-tags {
    padding: 0 1.25rem 1.25rem;
  }

  .featured-posts h2 {
    font-size: 1.6rem;
  }
}
  </style>

  <script>
    // @ts-nocheck
    // Accurate Moon Phase & Zodiac Calculator
    const SYNODIC_MONTH = 29.530588853;
    const NEW_MOON_EPOCH_JD = 2451550.1;
    const PHASE_OFFSET_DAYS = 0.706;

    const PHASE_BOUNDS = [
      0.0,
      1.84566,
      5.53699,
      9.22831,
      12.91963,
      16.61096,
      20.30228,
      23.99361,
      SYNODIC_MONTH,
    ];

    const PHASE_NAMES = [
      "New Moon",
      "Waxing Crescent",
      "First Quarter",
      "Waxing Gibbous",
      "Full Moon",
      "Waning Gibbous",
      "Last Quarter",
      "Waning Crescent",
    ];

    // Moon phase SVG icons (SVG)
    const PHASE_ICONS = [
      '<img src="/icons/moons/white/newmoon.svg" alt="New Moon">',
      '<img src="/icons/moons/white/waxingcrescent.svg" alt="Waxing Crescent">',
      '<img src="/icons/moons/white/firstquarter.svg" alt="First Quarter">',
      '<img src="/icons/moons/white/waxinggibbous.svg" alt="Waxing Gibbous">',
      '<img src="/icons/moons/white/fullmoon.svg" alt="Full Moon">',
      '<img src="/icons/moons/white/waninggibbous.svg" alt="Waning Gibbous">',
      '<img src="/icons/moons/white/lastquarter.svg" alt="Last Quarter">',
      '<img src="/icons/moons/white/waningcrescent.svg" alt="Waning Crescent">',
    ];

    const ZODIAC_SIGNS = [
      "Aries",
      "Taurus",
      "Gemini",
      "Cancer",
      "Leo",
      "Virgo",
      "Libra",
      "Scorpio",
      "Sagittarius",
      "Capricorn",
      "Aquarius",
      "Pisces",
    ];

    function toJulianDay(date) {
      return date.getTime() / 86400000 + 2440587.5;
    }

    function norm360(deg) {
      deg = deg % 360;
      return deg < 0 ? deg + 360 : deg;
    }

    function clamp01(x) {
      return Math.max(0, Math.min(1, x));
    }

    function getMoonAgeDays(date = new Date()) {
      const jd = toJulianDay(date);
      let age = (jd - NEW_MOON_EPOCH_JD + PHASE_OFFSET_DAYS) % SYNODIC_MONTH;
      if (age < 0) age += SYNODIC_MONTH;
      return age;
    }

    function getMoonPhaseName(date = new Date()) {
      const age = getMoonAgeDays(date);
      for (let i = 0; i < PHASE_BOUNDS.length - 1; i++) {
        if (age >= PHASE_BOUNDS[i] && age < PHASE_BOUNDS[i + 1]) {
          return { name: PHASE_NAMES[i], icon: PHASE_ICONS[i] };
        }
      }
      return { name: PHASE_NAMES[0], icon: PHASE_ICONS[0] };
    }

    function getMoonEclipticLongitude(date = new Date()) {
      const jd = toJulianDay(date);
      const d = jd - 2451545.0;

      const L = norm360(218.316 + 13.176396 * d);
      const Mm = norm360(134.963 + 13.064993 * d);
      const Ms = norm360(357.529 + 0.98560028 * d);
      const D = norm360(297.85 + 12.190749 * d);
      const F = norm360(93.272 + 13.22935 * d);

      const lon =
        L +
        6.289 * Math.sin((Mm * Math.PI) / 180) +
        1.274 * Math.sin(((2 * D - Mm) * Math.PI) / 180) +
        0.658 * Math.sin((2 * D * Math.PI) / 180) +
        0.214 * Math.sin((2 * Mm * Math.PI) / 180) -
        0.186 * Math.sin((Ms * Math.PI) / 180) -
        0.114 * Math.sin((2 * F * Math.PI) / 180);

      return norm360(lon);
    }

    function getMoonSign(date = new Date()) {
      return ZODIAC_SIGNS[Math.floor(getMoonEclipticLongitude(date) / 30)];
    }

    function getIlluminationFraction(date = new Date()) {
      const age = getMoonAgeDays(date);
      return clamp01(0.5 * (1 - Math.cos((2 * Math.PI * age) / SYNODIC_MONTH)));
    }

    function getMoonDayNumber(date = new Date()) {
      const age = getMoonAgeDays(date);
      return Math.floor(age) + 1;
    }

    // Update the moon phase display
    const moonPhaseEl = document.getElementById("moon-phase");
    if (moonPhaseEl) {
      const now = new Date();
      const phase = getMoonPhaseName(now);
      const sign = getMoonSign(now);
      const moonDay = getMoonDayNumber(now);
      const illumPct = (getIlluminationFraction(now) * 100).toFixed(1);

      moonPhaseEl.innerHTML = `
        <div class="moon-info-main">
          <span class="moon-icon">${phase.icon}</span>
          <div class="moon-text-group">
            <span class="moon-phase">${phase.name} in ${sign}</span>
            <span class="moon-divider">•</span>
            <span class="moon-details">Moon Day ${moonDay} • ${illumPct}% illuminated</span>
          </div>
        </div>
      `;
    }
  </script>
</BaseLayout>
