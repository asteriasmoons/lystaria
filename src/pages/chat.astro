---
// @ts-nocheck
import BaseLayout from "../layouts/BaseLayout.astro";
import Layout from "../layouts/Layout.astro";
---

<BaseLayout title="Chat - Lystaria">
  <div class="container">
    <!-- Page intro -->
    <section class="chat-intro">
      <h2>The Lystaria Chat</h2>
      <p class="intro-note">
        Welcome to the Lystaria chat. Remember the old chat rooms you could find
        on websites? Yup, thats exactly what is here. Please feel free to think
        out loud here but with some discernment about your language and what you
        share. My blogs are not just meant to be read but to be experienced and
        thats what this space allows you to do. For everyones safety, I have
        disabled link sharing. Thanks for stopping by.
      </p>
    </section>
  </div>
  <!-- Nickname Entry (shows first time) -->
  <div id="nicknamePrompt" class="nickname-prompt">
    <div class="prompt-content">
      <h2>Enter the chat</h2>
      <input
        type="text"
        id="nicknameInput"
        placeholder="Choose a nickname..."
        maxlength="20"
        autocomplete="off"
      />
      <button id="enterChat">Enter</button>
      <p class="hint">
        Messages auto-delete after 12 hours • 5 second slow mode
      </p>
    </div>
  </div>

  <!-- Chat Area (hidden until nickname set) -->
  <div id="chatArea" class="chat-area" style="display: none;">
    <div class="chat-wrapper">
      <div class="chat-header">
        <h1>Live Chat</h1>
        <div class="online-counter">
          <span class="pulse-dot"></span>
          <span id="onlineCount">— online</span>

          <button id="adminButton" class="admin-btn" type="button">Admin</button
          >
          <button id="leaveButton" class="leave-btn" type="button">Leave</button
          >
        </div>
      </div>

      <div class="messages-container" id="messagesContainer">
        <div class="loading">Loading messages...</div>
      </div>

      <div class="input-area">
        <div class="cooldown-bar" id="cooldownBar"></div>
        <div class="input-wrapper">
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message..."
            maxlength="500"
            autocomplete="off"
            disabled
          />
          <button id="sendButton" disabled>Send</button>
        </div>
        <div class="input-hints">
          <span id="cooldownText"></span>
          <span class="nickname-display"
            >Chatting as <strong id="currentNickname"></strong></span
          >
        </div>
      </div>
    </div>
  </div>

  <style is:global>
    /* =========================
     Chat Page Styles (Lystaria)
     - Uses your global tokens + fonts
     - No hard-coded “discord app” palette
     ========================= */

    /* Safety: ensure this page inherits your global background if anything overrides it */
    /* :global(body) {
      background-color: var(--color-bg);
      background-image: var(--bg-glow);
      background-repeat: no-repeat;
      background-attachment: scroll;
    }

    :global(main) {
      background: transparent;
    } */

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .chat-intro {
      max-width: 800px;
      margin: 2rem auto 1.25rem;
      padding: 0 1rem;
    }

    .chat-intro h2 {
      margin: 0 0 1rem;
      font-size: 2rem;
      line-height: 1.2;
    }

    .intro-note {
      max-width: 700px;
      margin: 3rem auto 0;
      padding: 2rem;
      border: 2px dotted rgba(243, 90, 254, 0.856);
      border-radius: 12px;
      font-size: 0.75rem;
      color: #ffffff;
      /* line-height: 1.5; */
    }

    /* Nickname Prompt - centered overlay */
    .nickname-prompt {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      -webkit-backdrop-filter: blur(var(--glass-blur));
      backdrop-filter: blur(var(--glass-blur));
    }

    .prompt-content {
      background: var(--glass-bg-strong);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 2.25rem;
      text-align: center;
      max-width: 420px;
      width: min(92vw, 420px);
      box-shadow: var(--glass-shadow);
    }

    .prompt-content h2 {
      margin: 0 0 1.25rem 0;
      font-family: "Berkshire Swash", serif;
      font-weight: 400;
      background-image: var(--gradient-heading);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      font-size: 1.8rem;
      line-height: 1.2;
    }

    .prompt-content input {
      width: 100%;
      padding: 0.95rem 1rem;
      background: rgba(10, 10, 15, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      color: var(--color-text);
      font-size: 1rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
      transition:
        border-color 0.2s,
        box-shadow 0.2s;
    }

    .prompt-content input::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    .prompt-content input:focus {
      outline: none;
      border-color: rgba(126, 126, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(126, 126, 255, 0.18);
    }

    .prompt-content button {
      width: 100%;
      padding: 0.95rem 1rem;
      background: var(--gradient-accent);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      color: var(--color-text);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition:
        transform 0.2s,
        box-shadow 0.2s,
        opacity 0.2s;
    }

    .prompt-content button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
    }

    .prompt-content button:active {
      transform: translateY(0);
      opacity: 0.95;
    }

    .hint {
      margin-top: 0.9rem;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.55);
    }

    /* Chat Area */
    .chat-area {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .chat-wrapper {
      /* Glass + Lystaria atmosphere */
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      box-shadow: var(--glass-shadow-soft);
      -webkit-backdrop-filter: blur(var(--glass-blur));
      backdrop-filter: blur(var(--glass-blur));
      overflow: hidden;
      /* Layout fix: app-panel behavior */
      display: flex;
      flex-direction: column;
      height: min(72vh, 720px);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.25rem;
      background: rgba(10, 10, 15, 0.35);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chat-header h1 {
      margin: 0;
      font-family: "Berkshire Swash", serif;
      font-weight: 400;
      background-image: var(--gradient-heading);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      font-size: 1.55rem;
      line-height: 1.2;
    }

    .online-counter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.65);
      font-family: inherit;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: rgba(0, 219, 255, 0.85);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .admin-btn,
    .leave-btn {
      margin-left: 0.6rem;
      padding: 0.35rem 0.6rem;
      border-radius: 10px;
      border: none;
      background: var(--overlay-gradient-accent);
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      font: inherit;
    }

    .admin-btn:hover,
    .leave-btn:hover {
      background: rgba(10, 10, 15, 0.35);
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.35;
      }
    }

    /* Messages Container */
    .messages-container {
      /* Layout fix: fill remaining space */
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      background: rgba(10, 10, 15, 0.18);
    }

    .messages-container::-webkit-scrollbar {
      width: 10px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.15);
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(126, 126, 255, 0.22);
      border-radius: 6px;
    }

    .messages-container::-webkit-scrollbar-thumb:hover {
      background: rgba(126, 126, 255, 0.35);
    }

    .loading {
      text-align: center;
      color: rgba(255, 255, 255, 0.55);
      padding: 2rem 1rem;
    }

    /* Message container - flex row */
    .message {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
      padding: 0;
      background: transparent;
      border: none;
      animation: fadeIn 0.25s ease-in;
      width: 100%; /* Container is full width */
    }

    /* Message bubble - COMPACT, not full width */
    .message-content {
      /* Remove flex: 1 - that's what's making it stretch */
      max-width: 80%; /* Max 70% of container width */
      min-width: 0;

      /* Bubble styling */
      padding: 0.5rem 0.75rem;
      border-radius: 12px;
      background: var(--overlay-gradient-accent);
      border: none;
      /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); */
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease;
    }

    .message:hover .message-content {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    .message-header {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .message-nickname {
      font-family: inherit;
      font-size: 0.9rem;
      line-height: 1.15;
      color: rgba(7, 7, 7, 0.95);
      font-weight: 600;
    }
    .message-timestamp {
      font-size: 0.75rem;
      color: rgb(2, 2, 2);
    }

    .message-text {
      color: rgb(255, 255, 255);
      line-height: 1.4;
      word-wrap: break-word;
      font-size: 0.9rem;
    }

    /* System message - small centered text, NO bubble */
    .system-message {
      text-align: center;
      font-size: 0.8rem;
      color: rgba(146, 115, 255, 0.6);
      padding: 0.35rem 0.5rem;
      margin: 0.5rem auto;
      background: transparent !important; /* Force no background */
      border: none !important;
      box-shadow: none !important;
      font-style: italic;
      max-width: fit-content;
    }

    /* Delete button positioning */
    .message-actions {
      opacity: 0;
      transition: opacity 0.2s;
      align-self: flex-start;
      padding-top: 0.5rem;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      display: none;
    }

    .delete-btn {
      background: var(--overlay-gradient-accent);
      border: none;
      color: rgba(255, 255, 255, 0.9);
      padding: 0.35rem 0.6rem;
      border-radius: 8px;
      font-size: 0.78rem;
      cursor: pointer;
      transition:
        transform 0.15s ease,
        background 0.15s ease,
        border-color 0.15s;
    }

    .delete-btn:hover {
      background: rgba(218, 37, 201, 0.18);
      border-color: rgba(218, 37, 201, 0.55);
      transform: translateY(-1px);
    }

    /* Input Area */
    .input-area {
      padding: 1rem 1.25rem;
      background: rgba(10, 10, 15, 0.35);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .cooldown-bar {
      height: 2px;
      background: var(--gradient-accent);
      border-radius: 2px;
      margin-bottom: 0.75rem;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.1s linear;
    }

    .input-wrapper {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .input-wrapper input {
      flex: 1;
      padding: 0.85rem 1rem;
      background: rgba(10, 10, 15, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      color: var(--color-text);
      font-size: 0.95rem;
      transition:
        border-color 0.2s,
        box-shadow 0.2s,
        opacity 0.2s;
    }

    .input-wrapper input:focus {
      outline: none;
      border-color: rgba(126, 126, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(126, 126, 255, 0.16);
    }

    .input-wrapper input:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .input-wrapper input::placeholder {
      color: rgba(255, 255, 255, 0.45);
    }

    /* SEND BUTTON!! */
    .input-wrapper button {
      padding: 0.85rem 1.25rem;
      background: var(--overlay-gradient-accent);
      border: none;
      border-radius: 10px;
      overflow: hidden;
      color: var(--color-text);
      font: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      position: relative;
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        opacity 0.2s;
      white-space: nowrap;
    }

    /* Clean “border” ring INSIDE the button (no bleed) */
    .input-wrapper button::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.18);
    }

    .input-wrapper button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
    }

    .input-wrapper button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .input-hints {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.6rem;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
    }

    #cooldownText {
      color: rgba(0, 219, 255, 0.85);
      font-weight: 500;
    }

    .nickname-display {
      color: rgba(146, 115, 255, 0.95);
    }

    .nickname-display strong {
      color: rgba(146, 115, 255, 0.95);
      font-weight: 600;
    }

    .system-delete {
      margin-left: 0.6rem;
      /* sizing */
      min-width: 72px;
      height: 28px;
      padding: 0 0.75rem;
      /* layout */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      /* visuals */
      background: var(--overlay-gradient-accent);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: none;
      border-radius: 999px;
      /* text */
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.75);
      cursor: pointer;
      transition:
        background 0.2s ease,
        color 0.2s ease,
        transform 0.15s ease;
    }

    .system-delete:hover {
      background: rgba(255, 255, 255, 0.12);
      color: rgba(255, 255, 255, 0.95);
      transform: translateY(-1px);
    }

    .system-delete:active {
      transform: translateY(0);
      background: rgba(255, 255, 255, 0.18);
    }

    /* Admin modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 30000;
    }

    .modal.is-open {
      display: block;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .modal-card {
      position: relative;
      width: min(92vw, 420px);
      margin: 14vh auto 0;
      padding: 1.25rem 1.25rem 1rem;

      background: var(--glass-bg-strong);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      box-shadow: var(--glass-shadow);
    }

    .modal-title {
      margin: 0 0 0.35rem 0;
      font-size: 1.25rem;
      line-height: 1.2;
    }

    .modal-subtitle {
      margin: 0 0 0.9rem 0;
      color: rgba(255, 255, 255, 0.65);
      font-size: 0.92rem;
      line-height: 1.4;
    }

    .modal-input {
      width: 100%;
      padding: 0.85rem 0.95rem;

      background: rgba(10, 10, 15, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;

      color: var(--color-text);
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .modal-input:focus {
      outline: none;
      border-color: rgba(126, 126, 255, 0.6);
      box-shadow: 0 0 0 3px rgba(126, 126, 255, 0.16);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.6rem;
      margin-top: 0.9rem;
    }

    .modal-btn {
      padding: 0.65rem 0.9rem;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font: inherit;
      cursor: pointer;
    }

    .modal-btn.secondary {
      background: rgba(10, 10, 15, 0.25);
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-btn.primary {
      background: var(--gradient-accent);
      color: rgba(255, 255, 255, 0.92);
    }

    /* =========================
   DELETE MODAL – BUTTONS
   ========================= */

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .modal-actions button {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 10px;
      padding: 0.55rem 1.25rem;

      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;

      color: var(--color-text);
      background: rgba(10, 10, 15, 0.35);

      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        opacity 0.2s ease;
    }

    /* Cancel button – soft glass */
    #deleteCancelBtn {
      background: var(--overlay-gradient-accent);
    }

    #deleteCancelBtn:hover {
      background: rgba(10, 10, 15, 0.45);
      transform: translateY(-1px);
    }

    /* Delete button – gradient danger */
    #deleteConfirmBtn {
      background: var(--overlay-gradient-accent);
      border-color: rgba(31, 26, 59, 0.25);
    }

    #deleteConfirmBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
    }

    #deleteConfirmBtn:active,
    #deleteCancelBtn:active {
      transform: translateY(0);
      opacity: 0.95;
    }

    /* ========================
		MOBILE MOBILE MOBILE
	   ======================= */
    @media (max-width: 768px) {
      .chat-area {
        padding: 1.25rem 0.9rem;
      }

      .prompt-content {
        padding: 1.75rem 1.25rem;
      }

      .chat-wrapper {
        height: min(74vh, 680px);
      }

      .chat-header {
        flex-direction: column;
        gap: 0.6rem;
        align-items: flex-start;
      }

      .chat-header h1 {
        font-size: 1.45rem;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.95rem;
      }

      .message-nickname {
        font-size: 1rem;
      }

      .input-wrapper {
        flex-direction: column;
        gap: 0.55rem;
        align-items: stretch;
      }

      .input-wrapper button {
        width: 100%;
      }

      .input-hints {
        flex-direction: column;
        gap: 0.25rem;
        align-items: flex-start;
      }
    }
  </style>

  <!-- DELETE MODAL -->
  <div id="deleteModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>
    <div class="modal-card">
      <h3>Delete message?</h3>
      <p>This action cannot be undone.</p>
      <div class="modal-actions">
        <button id="deleteCancelBtn">Cancel</button>
        <button id="deleteConfirmBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" data-close="true"></div>

    <div
      class="modal-card"
      role="dialog"
      aria-modal="true"
      aria-labelledby="adminModalTitle"
    >
      <h3 id="adminModalTitle" class="modal-title">Admin Mode</h3>
      <p class="modal-subtitle">
        Enter your admin key to enable admin controls.
      </p>

      <input
        id="adminKeyInput"
        class="modal-input"
        type="password"
        placeholder="Admin key..."
        autocomplete="off"
      />

      <div class="modal-actions">
        <button id="adminCancelBtn" type="button" class="modal-btn secondary"
          >Cancel</button
        >
        <button id="adminConfirmBtn" type="button" class="modal-btn primary"
          >Unlock</button
        >
      </div>
    </div>
  </div>

  <script>
    // @ts-nocheck
    import { initializeApp } from "firebase/app";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      remove,
      serverTimestamp,
      query,
      orderByChild,
    } from "firebase/database";
    import { filterProfanity } from "././utils/profanityFilter";

    // Firebase config from environment variables
    const firebaseConfig = {
      apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
      authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
      databaseURL: import.meta.env.PUBLIC_FIREBASE_DATABASE_URL,
      projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
      storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
      messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
      appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const messagesRef = ref(database, "messages");

    // State
    let nickname = localStorage.getItem("chatNickname") || "";
    let lastMessageTime = 0;
    const COOLDOWN_MS = 5000; // 5 seconds
    const MESSAGE_LIFETIME_MS = 12 * 60 * 60 * 1000; // 12 hours

    let pendingDeleteMessageId = null;

    const ADMIN_KEY = localStorage.getItem("chatAdminKey") || "";
    const ADMIN_SECRET = import.meta.env.PUBLIC_CHAT_ADMIN_KEY || "";

    // DOM elements
    const nicknamePrompt = document.getElementById("nicknamePrompt");
    const chatArea = document.getElementById("chatArea");
    const nicknameInput = document.getElementById("nicknameInput");
    const enterChatBtn = document.getElementById("enterChat");
    const messagesContainer = document.getElementById("messagesContainer");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const cooldownBar = document.getElementById("cooldownBar");
    const cooldownText = document.getElementById("cooldownText");
    const currentNicknameSpan = document.getElementById("currentNickname");
    const onlineCountSpan = document.getElementById("onlineCount");
    const adminBtn = document.getElementById("adminButton");
    const leaveBtn = document.getElementById("leaveButton");

    // Admin modal DOM (custom prompt replacement)
    const adminModal = document.getElementById("adminModal");
    const adminKeyInput = document.getElementById("adminKeyInput");
    const adminCancelBtn = document.getElementById("adminCancelBtn");
    const adminConfirmBtn = document.getElementById("adminConfirmBtn");

    // Delete modal DOM (custom confirm replacement)
    const deleteModal = document.getElementById("deleteModal");
    const deleteConfirmBtn = document.getElementById("deleteConfirmBtn");
    const deleteCancelBtn = document.getElementById("deleteCancelBtn");

    // Check if nickname exists
    if (nickname) {
      showChat();
    }

    function getTodayKey() {
      return new Date().toISOString().split("T")[0];
    }

    function isAdminSession() {
      return Boolean(ADMIN_SECRET) && ADMIN_KEY === ADMIN_SECRET;
    }

    function containsLink(text) {
      return /\b(?:https?:\/\/|www\.|[a-z0-9-]+\.(?:com|net|org|io|co|gg|me|dev|app|xyz|link|site|edu|gov)\b)/i.test(
        text
      );
    }

    // ===== Admin Modal Helpers =====
    function openAdminModal() {
      if (!adminModal) return;
      adminModal.classList.add("is-open");
      adminModal.setAttribute("aria-hidden", "false");

      if (adminKeyInput) {
        adminKeyInput.value = "";
        adminKeyInput.focus();
      }
    }

    function closeAdminModal() {
      if (!adminModal) return;
      adminModal.classList.remove("is-open");
      adminModal.setAttribute("aria-hidden", "true");
    }

    function submitAdminKey() {
      const key = String(adminKeyInput?.value || "").trim();
      if (!key) return;

      if (key === ADMIN_SECRET) {
        localStorage.setItem("chatAdminKey", key);
        window.showToast?.("Admin mode activated.");
        closeAdminModal();
        location.reload();
      } else {
        window.showToast?.("Nope.");
        if (adminKeyInput) adminKeyInput.value = "";
        adminKeyInput?.focus();
      }
    }

    adminCancelBtn?.addEventListener("click", closeAdminModal);
    adminConfirmBtn?.addEventListener("click", submitAdminKey);

    adminKeyInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submitAdminKey();
      if (e.key === "Escape") closeAdminModal();
    });

    adminModal?.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.dataset.close === "true") closeAdminModal();
    });

    // ===== Delete Modal Helpers =====
    function openDeleteModal(messageId) {
      pendingDeleteMessageId = messageId;
      if (!deleteModal) return;

      deleteModal.classList.add("is-open");
      deleteModal.setAttribute("aria-hidden", "false");
    }

    function closeDeleteModal() {
      pendingDeleteMessageId = null;
      if (!deleteModal) return;

      deleteModal.classList.remove("is-open");
      deleteModal.setAttribute("aria-hidden", "true");
    }

    function confirmDelete() {
      if (!pendingDeleteMessageId) return;

      remove(ref(database, `messages/${pendingDeleteMessageId}`));
      closeDeleteModal();
      window.showToast?.("Message deleted.");
    }

    deleteCancelBtn?.addEventListener("click", closeDeleteModal);
    deleteConfirmBtn?.addEventListener("click", confirmDelete);

    deleteModal?.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.dataset.close === "true") closeDeleteModal();
    });

    // Global Escape closes any open modal
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeAdminModal();
        closeDeleteModal();
      }
    });

    // Enter chat
    enterChatBtn?.addEventListener("click", handleEnterChat);
    nicknameInput?.addEventListener("keypress", (e) => {
      if (e.key === "Enter") handleEnterChat();
    });

    function handleEnterChat() {
      const inputNickname = (nicknameInput?.value || "").trim();

      if (inputNickname.length < 2) {
        alert("Nickname must be at least 2 characters");
        return;
      }

      if (inputNickname.length > 20) {
        alert("Nickname must be 20 characters or less");
        return;
      }

      nickname = inputNickname;
      localStorage.setItem("chatNickname", nickname);

      showChat();

      // Post "entered" only once per day
      const today = getTodayKey();
      const lastJoinDate = localStorage.getItem("lastJoinDate");

      if (lastJoinDate !== today) {
        push(messagesRef, {
          text: `${nickname} entered the chat`,
          nickname: "system",
          timestamp: serverTimestamp(),
        });

        localStorage.setItem("lastJoinDate", today);
      }
    }

    function showChat() {
      if (nicknamePrompt) nicknamePrompt.style.display = "none";
      if (chatArea) chatArea.style.display = "block";
      if (currentNicknameSpan) currentNicknameSpan.textContent = nickname;
      if (messageInput) messageInput.disabled = false;
      if (sendButton) sendButton.disabled = false;

      // Listen for messages
      listenForMessages();

      // Focus input
      messageInput?.focus();
    }

    // Send message
    sendButton?.addEventListener("click", sendMessage);
    messageInput?.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !sendButton?.disabled) {
        sendMessage();
      }
    });

    function sendMessage() {
      const text = (messageInput?.value || "").trim();
      if (!text) return;

      // LINK FILTER
      if (containsLink(text)) {
        window.showToast?.(
          "Links are disabled in this chat to prevent any harmful intent. Thank you for respecting that."
        );
        return;
      }

      // Check cooldown
      const now = Date.now();
      const timeSinceLastMessage = now - lastMessageTime;

      if (timeSinceLastMessage < COOLDOWN_MS) {
        const remaining = Math.ceil(
          (COOLDOWN_MS - timeSinceLastMessage) / 1000
        );
        if (cooldownText) {
          cooldownText.textContent = `Wait ${remaining}s before sending another message`;
        }
        return;
      }

      // Filter profanity
      const filteredText = filterProfanity(text);

      // Send to Firebase
      push(messagesRef, {
        text: filteredText,
        nickname: nickname,
        timestamp: serverTimestamp(),
      });

      // Clear input
      if (messageInput) messageInput.value = "";
      lastMessageTime = now;

      // Start cooldown
      startCooldown();
    }

    function startCooldown() {
      if (sendButton) sendButton.disabled = true;
      if (messageInput) messageInput.disabled = true;

      let remaining = COOLDOWN_MS / 1000;
      if (cooldownText) cooldownText.textContent = `Wait ${remaining}s...`;

      // Animate cooldown bar
      if (cooldownBar) cooldownBar.style.transform = "scaleX(1)";

      const interval = setInterval(() => {
        remaining--;
        if (remaining > 0) {
          if (cooldownText) cooldownText.textContent = `Wait ${remaining}s...`;
        } else {
          if (cooldownText) cooldownText.textContent = "";
          if (sendButton) sendButton.disabled = false;
          if (messageInput) messageInput.disabled = false;
          if (cooldownBar) cooldownBar.style.transform = "scaleX(0)";
          clearInterval(interval);
          messageInput?.focus();
        }
      }, 1000);
    }

    // Listen for messages
    function listenForMessages() {
      const messagesQuery = query(messagesRef, orderByChild("timestamp"));

      onValue(messagesQuery, (snapshot) => {
        if (!messagesContainer) return;

        messagesContainer.innerHTML = "";

        const messages = [];
        const now = Date.now();

        snapshot.forEach((childSnapshot) => {
          const messageData = childSnapshot.val();
          const messageId = childSnapshot.key;
          const messageTime = messageData.timestamp || 0;

          // Delete old messages
          if (now - messageTime > MESSAGE_LIFETIME_MS) {
            remove(ref(database, `messages/${messageId}`));
            return;
          }

          messages.push({
            id: messageId,
            ...messageData,
          });
        });

        // Update online count (rough estimate)
        if (onlineCountSpan) {
          const uniqueNicknames = new Set(messages.map((m) => m.nickname));
          onlineCountSpan.textContent = `${Math.max(1, uniqueNicknames.size)} online`;
        }

        // Render messages
        messages.forEach(renderMessage);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Render messages
    function renderMessage(message) {
      const isAdmin = isAdminSession();

      // System message rendering (admin can delete)
      if (message.nickname === "system") {
        const systemEl = document.createElement("div");
        systemEl.className = "system-message";

        const textEl = document.createElement("span");
        textEl.textContent = message.text;
        systemEl.appendChild(textEl);

        if (isAdmin && message.id) {
          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "system-delete";
          deleteBtn.textContent = "Delete";

          deleteBtn.addEventListener("click", () => {
            openDeleteModal(message.id);
          });

          systemEl.appendChild(deleteBtn);
        }

        messagesContainer?.appendChild(systemEl);
        return;
      }

      const messageEl = document.createElement("div");
      messageEl.className = "message";

      const timestamp = message.timestamp
        ? new Date(message.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          })
        : "";

      messageEl.innerHTML = `
      <div class="message-content">
        <div class="message-header">
          <span class="message-nickname">${escapeHtml(message.nickname)}</span>
          <span class="message-timestamp">${timestamp}</span>
        </div>
        <div class="message-text">${escapeHtml(message.text)}</div>
      </div>
      ${
        isAdmin
          ? `<div class="message-actions">
               <button class="delete-btn" data-id="${message.id}">Delete</button>
             </div>`
          : ""
      }
    `;

      // Add delete handler for admin
      if (isAdmin) {
        const deleteBtn = messageEl.querySelector(".delete-btn");
        deleteBtn?.addEventListener("click", () => {
          openDeleteModal(message.id);
        });
      }

      messagesContainer?.appendChild(messageEl);
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = String(text ?? "");
      return div.innerHTML;
    }

    // Admin button (visible)
    function updateAdminButton() {
      if (!adminBtn) return;
      adminBtn.textContent = isAdminSession() ? "Exit Admin" : "Admin";
    }

    updateAdminButton();

    adminBtn?.addEventListener("click", () => {
      if (isAdminSession()) {
        localStorage.removeItem("chatAdminKey");
        window.showToast?.("Admin mode turned off.");
        location.reload();
        return;
      }

      openAdminModal();
    });

    // Ctrl+Shift+A opens modal or exits admin
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === "A") {
        if (isAdminSession()) {
          localStorage.removeItem("chatAdminKey");
          window.showToast?.("Admin mode turned off.");
          location.reload();
        } else {
          openAdminModal();
        }
      }
    });

    // Leave button (clear nickname + return to prompt)
    leaveBtn?.addEventListener("click", () => {
      if (nickname) {
        push(messagesRef, {
          text: `${nickname} left the chat`,
          nickname: "system",
          timestamp: serverTimestamp(),
        });
      }

      localStorage.removeItem("chatNickname");
      localStorage.removeItem("chatAdminKey");

      location.reload();
    });
  </script>
</BaseLayout>
