---
// @ts-nocheck
// Horoscopes Page
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCachedHoroscopes } from "@/lib/horoscopeCache";

const API_KEY = import.meta.env.API_NINJAS_KEY;

const signs = [
  { name: "aries", dates: "Mar 21 - Apr 19" },
  { name: "taurus", dates: "Apr 20 - May 20" },
  { name: "gemini", dates: "May 21 - Jun 20" },
  { name: "cancer", dates: "Jun 21 - Jul 22" },
  { name: "leo", dates: "Jul 23 - Aug 22" },
  { name: "virgo", dates: "Aug 23 - Sep 22" },
  { name: "libra", dates: "Sep 23 - Oct 22" },
  { name: "scorpio", dates: "Oct 23 - Nov 21" },
  { name: "sagittarius", dates: "Nov 22 - Dec 21" },
  { name: "capricorn", dates: "Dec 22 - Jan 19" },
  { name: "aquarius", dates: "Jan 20 - Feb 18" },
  { name: "pisces", dates: "Feb 19 - Mar 20" }
];

const horoscopes = await getCachedHoroscopes(async () => {
  const results = {};

  async function fetchWithTimeout(url, options = {}, ms = 4500) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), ms);

    try {
      const res = await fetch(
        url,
        Object.assign({}, options, { signal: controller.signal })
      );
      return res;
    } finally {
      clearTimeout(timeout);
    }
  }

  const requests = signs.map(async (sign) => {
    try {
      const response = await fetchWithTimeout(
        "https://api.api-ninjas.com/v1/horoscope?zodiac=" + sign.name,
        {
          headers: {
            "X-Api-Key": API_KEY
          }
        }
      );

      if (!response.ok) {
        throw new Error("HTTP " + response.status);
      }

      const data = await response.json();
      results[sign.name] = {
        horoscope: data.horoscope,
        dates: sign.dates
      };
    } catch (error) {
      console.error("Error fetching " + sign.name + ":", error);
      results[sign.name] = {
        horoscope: "Horoscope unavailable at this time.",
        dates: sign.dates
      };
    }
  });

  await Promise.all(requests);
  return results;
});

const today = new Date().toLocaleDateString("en-US", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric"
});
---

<BaseLayout
  title="Daily Horoscopes | Lystaria"
  description="Your daily horoscope readings for all zodiac signs"
  image="/banner.png"
  type="website"
>
  <!-- HERO -->
  <section class="horoscopes-hero">
    <header class="horoscope-header">
      <h1>Daily Horoscopes</h1>
      <p class="date">{today}</p>
    </header>
  </section>

  <!-- GRID -->
  <section class="horoscopes-grid">
    <div class="horoscopes-container">
      {
        signs.map((sign) => {
          const data = horoscopes[sign.name];
          return (
            <article class="horoscope-card">
              <div class="sign-header">
                <h2>{sign.name}</h2>
                <span class="sign-dates">{data.dates}</span>
              </div>
              <p class="horoscope-text">{data.horoscope}</p>
            </article>
          );
        })
      }
    </div>
  </section>

  <!-- FOOTER -->
  <section class="horoscopes-footer">
    <footer class="horoscope-footer">
      <a href="/">‚Üê Back to Home</a>
    </footer>
  </section>

<style>
  /* HEADER */
  .horoscope-header {
    text-align: center;
    padding-top: 1rem;
    margin-bottom: 1rem; /* reduced from 3rem */
  }

  .date {
    color: #5ac7fa;
    font-size: 1.1rem; /* slightly tighter */
  }

  /* GRID */
  .horoscopes-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;            /* reduced from 2rem */
    width: 100%;
    margin: 0 auto 1.5rem;  /* reduced from 3rem */
  }

  /* CARD */
  .horoscope-card {
    background: rgba(126, 126, 255, 0.05);
    border: 1px solid rgba(126, 126, 255, 0.2);
    border-radius: 12px;
    padding: 1.25rem; /* reduced from 1.5rem */
    transition: transform 0.2s, border-color 0.2s;
  }

  .horoscope-card:hover {
    transform: translateY(-3px); /* slightly less jumpy */
    border-color: rgba(126, 126, 255, 0.4);
  }

  .sign-header {
    display: flex;
    align-items: center;
    gap: 0.75rem; /* reduced from 1rem */
    margin-bottom: 0.75rem; /* reduced from 1rem */
    padding-bottom: 0.75rem; /* reduced from 1rem */
    border-bottom: 1px solid rgba(126, 126, 255, 0.2);
  }

  .horoscope-card h2 {
    font-size: 1.5rem;
    color: #5ac7fa;
    margin: 0;
    text-transform: capitalize;
    flex-grow: 1;
    background: none;
    -webkit-background-clip: initial;
    background-clip: initial;
    -webkit-text-fill-color: #5ac7fa;
  }

  .sign-dates {
    font-size: 0.9rem;
    color: #7e7eff;
    white-space: nowrap; /* keeps dates from wrapping weirdly */
  }

  .horoscope-text {
    font-size: 0.95rem; /* tiny bump for readability */
    color: #e0e0e0;
    line-height: 1.65; /* slightly tighter than 1.7 */
    margin: 0; /* prevents default <p> spacing adding extra gaps */
  }

  /* FOOTER */
  .horoscope-footer {
    text-align: center;
    margin-top: 1.5rem; /* reduced from 3rem */
    padding-bottom: 2rem; /* gives a nice page end without huge emptiness */
  }

  .horoscope-footer a {
    display: inline-block;
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    font-weight: 500;
    color: #ffffff;
    background: rgba(10, 10, 15, 0.75);
    border: 1px solid var(--color-border);
    border-radius: 999px;
    text-decoration: none;
    letter-spacing: 0.02em;
    transition: all 0.25s ease;
  }

  .horoscope-footer a:hover {
    border-color: var(--color-accent);
    background: rgba(10, 10, 15, 0.9);
    transform: translateY(-1px);
  }

  /* MOBILE */
  @media (max-width: 1100px) {
    .horoscope-header {
      padding-top: 1.25rem;
      margin-bottom: 1.25rem;
    }

    .horoscope-header h1 {
      font-size: 2rem;
    }

    .horoscopes-container {
      grid-template-columns: min(600px, 100%);
      justify-content: center;
      gap: 1.25rem;            /* tighter */
      margin-bottom: 1.25rem;  /* tighter */
    }

    .horoscope-card {
      padding: 1.1rem; /* slightly tighter on mobile */
    }

    .horoscope-footer {
      margin-top: 1.25rem;
      padding-bottom: 1.75rem;
    }
  }
</style>
</BaseLayout>
