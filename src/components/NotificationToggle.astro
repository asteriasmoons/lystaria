---
// No props
---

<div class="notification-wrapper">
  <button
    id="notification-trigger"
    class="notify-btn"
    aria-label="Notifications"
  >
    <img src="/icons/bell.svg" alt="" class="notify-icon-img" />
  </button>

  <div id="notification-popup" class="notification-popup">
    <h3>Notifications</h3>
    <p id="notification-description" class="notification-description">
      Get notified when new posts are published
    </p>
    <button id="enable-notifications" class="notification-action-btn">
      Turn On Notifications
    </button>
  </div>
</div>

<style>
  .notification-wrapper {
    position: relative;
  }

  .notify-btn {
    /* Use same styling as your nav toggle */
  }

  .notification-popup {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: #1a1a1a;
    border: 1px solid rgba(126, 126, 255, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
    min-width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
  }

  .notification-popup.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .notification-popup h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1.125rem;
    color: #fff;
    font-family: "Berkshire Swash", cursive;
  }

  .notification-description {
    margin: 0 0 1rem 0;
    font-size: 0.875rem;
    color: #999;
    line-height: 1.5;
  }

  .notification-action-btn {
    width: 100%;
    background: linear-gradient(135deg, #7e7eff 0%, #5ac8fa 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition:
      transform 0.2s,
      opacity 0.2s;
  }

  .notification-action-btn:hover {
    transform: translateY(-2px);
  }

  .notification-action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .notification-action-btn.enabled {
    background: #2d2d2d;
    color: #5ac8fa;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .notification-popup {
      right: -1rem;
      min-width: 260px;
    }
  }
</style>

<script>
  import { requestNotificationPermission } from "../lib/firebase-messaging";
  import { getDatabase, ref, set } from "firebase/database";
  import { initializeApp } from "firebase/app";

  const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.PUBLIC_FIREBASE_APP_ID,
    databaseURL: import.meta.env.PUBLIC_FIREBASE_DATABASE_URL,
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const trigger = document.getElementById(
    "notification-trigger"
  ) as HTMLButtonElement;
  const popup = document.getElementById("notification-popup") as HTMLElement;
  const actionBtn = document.getElementById(
    "enable-notifications"
  ) as HTMLButtonElement;
  const description = document.getElementById(
    "notification-description"
  ) as HTMLElement;

  // Check if already subscribed
  const isSubscribed = localStorage.getItem("notificationsEnabled") === "true";

  if (isSubscribed) {
    actionBtn.textContent = "Notifications Enabled";
    actionBtn.classList.add("enabled");
    actionBtn.disabled = true;
    description.textContent = "You'll be notified when new posts are published";
  }

  // Toggle popup
  trigger.addEventListener("click", (e) => {
    e.stopPropagation();
    popup.classList.toggle("show");
  });

  // Close popup when clicking outside
  document.addEventListener("click", (e) => {
    if (!popup.contains(e.target as Node) && e.target !== trigger) {
      popup.classList.remove("show");
    }
  });

  // Enable notifications
  actionBtn.addEventListener("click", async () => {
    if (isSubscribed) return;

    actionBtn.disabled = true;
    actionBtn.textContent = "Requesting...";

    const token = await requestNotificationPermission();

    if (token) {
      // Save token to Firebase
      const tokenRef = ref(
        db,
        `push-tokens/${token.replace(/[.#$[\]]/g, "_")}`
      );

      await set(tokenRef, {
        token: token,
        subscribedAt: Date.now(),
        device: "iOS",
      });

      localStorage.setItem("notificationsEnabled", "true");
      actionBtn.textContent = "Notifications Enabled";
      actionBtn.classList.add("enabled");
      description.textContent =
        "You'll be notified when new posts are published";

      // Close popup after 2 seconds
      setTimeout(() => {
        popup.classList.remove("show");
      }, 2000);
    } else {
      // Permission denied
      actionBtn.textContent = "Permission Denied";
      actionBtn.disabled = false;
      description.textContent =
        "Please enable notifications in your browser settings";
    }
  });
</script>
